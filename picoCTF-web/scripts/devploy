#!/bin/sh

# Transpile the CoffeeScript files
echo "Transpiling Coffeescript"
coffee -c -o /home/vagrant/web/js/ /home/vagrant/web/coffee/

echo "Running jsxhint"
jsxhint /home/vagrant/minigames/jsx/*.jsx

echo "Transpiling jsx -> js"
jsx -x jsx /home/vagrant/minigames/jsx/ /home/vagrant/minigames/js/

echo "Compiling js files"
java -jar /usr/share/java/closure-compiler.jar --language_in ECMASCRIPT5 --formatting PRETTY_PRINT --compilation_level WHITESPACE_ONLY --js /home/vagrant/minigames/js/*.js --js_output_file /home/vagrant/minigames/js/libs/IPF.min.js

# Shutdown the server
echo "Shutting down nginx"
sudo service nginx stop

# Clean out the old files
echo "Cleaning up old files"
sudo rm -rf /srv/http/ctf/*

# Copy files to the server
echo "Copying files to server"
sudo cp /home/vagrant/web/*.html /srv/http/ctf
sudo cp -r /home/vagrant/web/js /srv/http/ctf
sudo cp -r /home/vagrant/web/sjs /srv/http/ctf
sudo cp -r /home/vagrant/web/css /srv/http/ctf
sudo cp -r /home/vagrant/minigames /srv/http/ctf
sudo cp -r /home/vagrant/game /srv/http/ctf

# Start the server
echo "Restarting the server"
sudo service nginx start
